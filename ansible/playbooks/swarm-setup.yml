---
# Docker Swarm Cluster Setup Playbook
# This playbook sets up a complete Docker Swarm cluster on Raspberry Pi 5 nodes
#
# Usage:
#   ansible-playbook playbooks/swarm-setup.yml
#   ansible-playbook playbooks/swarm-setup.yml --limit swarm_managers
#   ansible-playbook playbooks/swarm-setup.yml --limit swarm_workers

- name: Install Docker Engine and configure Docker Swarm
  become: true
  become_method: sudo
  gather_facts: true
  hosts: swarm
  # Run all hosts in parallel for Docker/network setup
  # Swarm initialization will handle serialization internally
  serial: "100%"
  vars:
    docker_compose_version: "2.24.0"

  pre_tasks:
    - name: Set hostname if target_hostname is defined
      ansible.builtin.hostname:
        name: "{{ target_hostname }}"
      when: target_hostname is defined
      tags: [hostname, always]

    - name: Update /etc/hosts with new hostname
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1\s+.*'
        line: "127.0.1.1\t{{ target_hostname }} {{ target_hostname }}.local"
        state: present
      when: target_hostname is defined
      tags: [hostname, always]

  roles:
    - role: sudo
      tags: [sudo, users]

    - role: docker
      tags: [docker, install]

    - role: network
      tags: [network, vlans]

    - role: storage
      tags: [storage, nfs]

    - role: keepalived
      tags: [keepalived, ha, vip]
      when: keepalived_priority is defined

    - role: swarm
      tags: [swarm, cluster]
      when: swarm_role is defined

    - role: docker-cleanup
      tags: [docker, cleanup, maintenance]
